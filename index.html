<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIT_LAB æ•¸ä½å½±åƒå¯¦é©—å®¤</title>
    
    <!-- 1. å¼•å…¥ React æ ¸å¿ƒ -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- 2. å¼•å…¥ Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 4. è¨­å®šå­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        
        /* è‡ªå®šç¾©æ¨£å¼è£œå…… */
        /* æ ¼ç·šé¡è‰²ç¶­æŒ slate-400 */
        .pixel-grid { display: grid; gap: 1px; background-color: #94a3b8; border: 4px solid #cbd5e1; border-radius: 8px; overflow: hidden; }
        .pixel-cell { cursor: pointer; transition: all 0.1s; }
        .pixel-cell:hover { transform: scale(0.95); border-radius: 4px; }
        .fun-input {
            background: #ffffff; border: 2px solid #cbd5e1; color: #334155;
            padding: 0.75rem; border-radius: 0.75rem; width: 100%;
            transition: all 0.2s;
        }
        .fun-input:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .fun-card { background: white; border-radius: 1.5rem; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .fun-btn { transition: transform 0.1s; }
        .fun-btn:active { transform: scale(0.95); }
        
        /* èªªæ˜æ¡†æ¨£å¼ */
        .guide-box {
            background-color: #f0f9ff; /* blue-50 */
            border-left: 4px solid #3b82f6; /* blue-500 */
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            color: #334155;
            line-height: 1.6;
        }
        .guide-title {
            font-weight: bold;
            color: #2563eb;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .target-box {
            border: 4px dashed #f59e0b; /* orange-500 */
            border-radius: 1rem;
            padding: 1rem;
            background-color: #fffbeb; /* amber-50 */
        }

        /* Toast å‹•ç•« */
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .animate-shake { animation: shake 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-blue-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- å…§å»ºåœ–ç¤ºå…ƒä»¶ ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Icons = {
            Terminal: (props) => <IconBase {...props}><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></IconBase>,
            Cpu: (props) => <IconBase {...props}><rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><rect x="9" y="9" width="6" height="6"/><line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/><line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/><line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="14" x2="23" y2="14"/><line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="14" x2="4" y2="14"/></IconBase>,
            Grid: (props) => <IconBase {...props}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></IconBase>,
            Eye: (props) => <IconBase {...props}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></IconBase>,
            Save: (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>,
            Lock: (props) => <IconBase {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>,
            CheckCircle: (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>,
            Monitor: (props) => <IconBase {...props}><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></IconBase>,
            Play: (props) => <IconBase {...props}><polygon points="5 3 19 12 5 21 5 3"/></IconBase>,
            RotateCcw: (props) => <IconBase {...props}><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></IconBase>,
            Award: (props) => <IconBase {...props}><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></IconBase>,
            Mail: (props) => <IconBase {...props}><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></IconBase>,
            Send: (props) => <IconBase {...props}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></IconBase>,
            Lightbulb: (props) => <IconBase {...props}><path d="M9 18h6"/><path d="M10 22h4"/><path d="M12 2v1"/><path d="M12 15a5 5 0 0 1 5-5 5 5 0 0 1 5 5v2a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-2a5 5 0 0 1 5-5 5 5 0 0 1 5 5z"/></IconBase>
        };

        const { Terminal, Cpu, Grid, Eye, Save, Lock, CheckCircle, Monitor, Play, RotateCcw, Award, Mail, Send, Lightbulb } = Icons;

        const App = () => {
            const [level, setLevel] = useState(-1);
            const [userInfo, setUserInfo] = useState({ classCode: '', seatNo: '', name: '', email: '' });
            const [gameData, setGameData] = useState([]);
            const [totalScore, setTotalScore] = useState(0);
            const [toast, setToast] = useState(null);

            const showToast = (msg, type = 'success') => {
                setToast({ msg, type });
                setTimeout(() => setToast(null), 3000);
            };

            const addScore = (points) => {
                setTotalScore(prev => prev + points);
                showToast(`ç²å¾— ${points} åˆ†ï¼`, 'score');
            };

            const submitLevelData = async (levelIndex, details, points = 0) => {
                if (points > 0) addScore(points);

                const payload = {
                    timestamp: new Date().toISOString(),
                    student: `${userInfo.classCode}-${userInfo.seatNo}`,
                    name: userInfo.name,
                    level: levelIndex,
                    scoreObtained: points,
                    ...details
                };

                console.log(`ğŸ“¤ [Level ${levelIndex} Data]`, payload);
                setGameData(prev => [...prev, payload]);
            };

            const nextLevel = () => setLevel(l => l + 1);

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4 relative overflow-hidden transition-colors duration-500">
                    <div className="absolute top-10 left-10 text-blue-200 opacity-50 animate-bounce"><Grid size={64}/></div>
                    <div className="absolute bottom-10 right-10 text-orange-200 opacity-50 animate-pulse"><Cpu size={80}/></div>
                    <div className="absolute top-1/2 left-10 text-pink-200 opacity-30 rotate-12"><Save size={48}/></div>

                    {toast && (
                        <div className={`fixed top-5 right-5 z-50 px-6 py-4 rounded-xl shadow-xl border-l-8 transform transition-all animate-[slideIn_0.3s_ease-out] flex items-center gap-3 font-bold
                            ${toast.type === 'success' ? 'bg-white border-green-400 text-green-700' : 
                            toast.type === 'error' ? 'bg-white border-red-400 text-red-700' :
                            'bg-white border-yellow-400 text-orange-600'}`}> 
                            {toast.type === 'score' && <Award className="text-yellow-500" />}
                            {toast.msg}
                        </div>
                    )}

                    <header className="w-full max-w-5xl flex justify-between items-center mb-6 z-10 bg-white/80 backdrop-blur px-6 py-3 rounded-2xl shadow-sm border border-white">
                        <div className="flex items-center gap-3 text-indigo-600">
                            <div className="bg-indigo-100 p-2 rounded-lg"><Terminal size={24} /></div>
                            <h1 className="text-xl font-extrabold tracking-tight">BIT_LAB <span className="text-indigo-400 font-medium">// æ•¸ä½å½±åƒå¯¦é©—å®¤</span></h1>
                        </div>
                        <div className="flex gap-6 text-sm font-medium text-slate-500 items-center">
                            {userInfo.name && <span className="hidden md:inline-block bg-slate-100 px-3 py-1 rounded-full">å­¸å“¡ï¼š{userInfo.name}</span>}
                            {level >= 0 && (
                                <div className="flex items-center gap-2 bg-yellow-100 text-yellow-700 px-4 py-1.5 rounded-full shadow-inner">
                                    <Award size={18} />
                                    <span className="font-bold text-lg">{totalScore}</span> <span className="text-xs opacity-75">PTS</span>
                                </div>
                            )}
                        </div>
                    </header>

                    <main className="w-full max-w-5xl fun-card p-8 z-10 min-h-[600px] flex flex-col relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                        
                        {level === -1 && <LoginScreen onLogin={(info) => { setUserInfo(info); setLevel(0); }} />}
                        {level === 0 && <Level0_Resolution onNext={nextLevel} onSubmit={submitLevelData} />}
                        {level === 1 && <Level1_PixelArt onNext={nextLevel} onSubmit={submitLevelData} />}
                        {level === 2 && <Level2_Binary onNext={nextLevel} onSubmit={submitLevelData} />}
                        {level === 3 && <Level3_ColorDepth onNext={nextLevel} onSubmit={submitLevelData} />}
                        {level === 4 && <Level4_RLE onNext={nextLevel} onSubmit={submitLevelData} />}
                        {level === 5 && <Level5_Boss onNext={nextLevel} onSubmit={submitLevelData} />}
                        {level === 6 && <Level6_Quiz onNext={nextLevel} onSubmit={submitLevelData} />}
                        {level === 7 && <EndScreen userInfo={userInfo} score={totalScore} gameData={gameData} showToast={showToast} />}
                    </main>

                    <footer className="mt-8 text-slate-400 text-sm font-medium text-center z-10">
                        Designed for CS Education â€¢ å°åŒ—å¸‚ç«‹é™½æ˜é«˜ä¸­
                    </footer>
                </div>
            );
        };

        // --- Login Screen ---
        const LoginScreen = ({ onLogin }) => {
            const [formData, setFormData] = useState({ classCode: '', seatNo: '', name: '', email: '' });
            const handleChange = (e) => setFormData({...formData, [e.target.name]: e.target.value});
            const handleSubmit = (e) => {
                e.preventDefault();
                if(Object.values(formData).every(v => v)) {
                    onLogin(formData);
                }
            };
            return (
                <div className="flex flex-col items-center justify-center h-full space-y-8 animate-[slideIn_0.5s_ease-out]">
                    <div className="text-center space-y-3">
                        <div className="bg-indigo-100 w-24 h-24 rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-lg rotate-3 hover:rotate-6 transition-transform">
                            <Cpu size={48} className="text-indigo-600" />
                        </div>
                        <h2 className="text-4xl font-extrabold text-slate-800">å­¸å“¡å ±åˆ°</h2>
                        <p className="text-slate-500 text-lg">è¼¸å…¥è³‡æ–™ä»¥å•Ÿå‹•å¯¦é©—ç´€éŒ„ç³»çµ±</p>
                    </div>
                    <form onSubmit={handleSubmit} className="w-full max-w-md space-y-4 bg-slate-50 p-6 rounded-2xl border border-slate-100">
                        <div className="grid grid-cols-2 gap-4">
                            <div><label className="block text-sm font-bold text-slate-600 mb-1 ml-1">ç­ç´š</label><input name="classCode" type="text" className="fun-input" placeholder="702" onChange={handleChange} required /></div>
                            <div><label className="block text-sm font-bold text-slate-600 mb-1 ml-1">åº§è™Ÿ</label><input name="seatNo" type="number" className="fun-input" placeholder="15" onChange={handleChange} required /></div>
                        </div>
                        <div><label className="block text-sm font-bold text-slate-600 mb-1 ml-1">çœŸå¯¦å§“å</label><input name="name" type="text" className="fun-input" placeholder="ç‹å°æ˜" onChange={handleChange} required /></div>
                        <div><label className="block text-sm font-bold text-slate-600 mb-1 ml-1">é›»å­ä¿¡ç®±</label><input name="email" type="email" className="fun-input" placeholder="student@example.com" onChange={handleChange} required /></div>
                        <button type="submit" className="fun-btn w-full bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 text-lg mt-4"><Play size={20} fill="currentColor" /> é–‹å§‹é—–é—œ</button>
                    </form>
                </div>
            );
        };

        // --- Level 0: Resolution ---
        const Level0_Resolution = ({ onNext, onSubmit }) => {
            const [res, setRes] = useState(10);
            const canvasRef = useRef(null);
            const imgSrc = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400' viewBox='0 0 400 400'%3E%3Crect width='400' height='400' fill='%23fca5a5'/%3E%3Ccircle cx='200' cy='200' r='100' fill='%23fde047'/%3E%3Crect x='150' y='150' width='30' height='30' fill='%231e293b'/%3E%3Crect x='220' y='150' width='30' height='30' fill='%231e293b'/%3E%3Cpath d='M 150 250 Q 200 300 250 250' stroke='%231e293b' stroke-width='10' fill='none'/%3E%3C/svg%3E";

            // è¨ˆç®—ç•¶å‰çš„ pixelSize å’Œé ä¼°ç¶²æ ¼æ•¸
            const pixelSize = Math.max(1, Math.floor(40 - (res * 0.4) + 1));
            const approxGrid = Math.floor(300 / pixelSize);

            useEffect(() => {
                const canvas = canvasRef.current;
                if(!canvas) return;
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.src = imgSrc;
                img.onload = () => {
                    const w = canvas.width;
                    const h = canvas.height;
                    ctx.imageSmoothingEnabled = false;
                    ctx.drawImage(img, 0, 0, w / pixelSize, h / pixelSize);
                    ctx.drawImage(canvas, 0, 0, w / pixelSize, h / pixelSize, 0, 0, w, h);
                    
                    if (pixelSize > 5) {
                        ctx.strokeStyle = "rgba(0,0,0,0.1)";
                        ctx.beginPath();
                        for(let x=0; x<=w; x+=pixelSize) { ctx.moveTo(x,0); ctx.lineTo(x,h); }
                        for(let y=0; y<=h; y+=pixelSize) { ctx.moveTo(0,y); ctx.lineTo(w,y); }
                        ctx.stroke();
                    }
                };
            }, [res, pixelSize]);

            return (
                <div className="flex flex-col h-full gap-6">
                    <div className="flex justify-between items-start border-b border-slate-100 pb-4">
                        <div>
                            <div className="flex items-center gap-2 mb-1">
                                <span className="bg-orange-100 text-orange-600 px-2 py-0.5 rounded text-xs font-bold">Level 0</span>
                                <h2 className="text-2xl font-bold text-slate-800">äººçœ¼ vs é›»è…¦</h2>
                            </div>
                            <p className="text-slate-500">é›»è…¦çœ‹åˆ°çš„ä¸æ˜¯ã€Œåœ–ã€ï¼Œæ˜¯æ ¼å­ã€‚æ‹–å‹•æ»‘æ¡¿é«”é©—é›»è…¦çš„è¦–è§’ã€‚</p>
                        </div>
                        <div className="text-right">
                            <span className="text-sm font-bold text-slate-400 block">éé—œçå‹µ</span>
                            <span className="text-xl font-bold text-indigo-600">+10 åˆ†</span>
                        </div>
                    </div>
                    
                    <div className="flex-1 flex flex-col md:flex-row gap-8 items-center justify-center">
                        <div className="border-8 border-slate-200 rounded-2xl overflow-hidden shadow-xl bg-white">
                            <canvas ref={canvasRef} width={300} height={300} className="block"></canvas>
                        </div>
                        
                        <div className="w-full md:w-1/3 space-y-6">
                            <div className="bg-slate-50 p-6 rounded-2xl space-y-4">
                                <div className="space-y-2">
                                    <label className="flex justify-between text-sm font-bold text-slate-700">
                                        <span>é¦¬è³½å…‹åŒ– (æ¨¡ç³Š)</span>
                                        <span>é«˜è§£æåº¦ (æ¸…æ™°)</span>
                                    </label>
                                    <input type="range" min="1" max="100" value={res} onChange={(e)=>setRes(parseInt(e.target.value))} 
                                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
                                </div>

                                <div className="text-center p-4 bg-white rounded-xl shadow-sm border border-slate-100">
                                    <p className="text-sm text-slate-500 mb-1">ç›®å‰æ¨¡æ“¬ç¶²æ ¼</p>
                                    <p className="text-2xl font-bold text-indigo-600 font-mono">ç´„ {approxGrid} (å¯¬) x {approxGrid} (é«˜)</p>
                                </div>
                            </div>

                            <div className="guide-box">
                                <div className="guide-title"><Lightbulb size={18}/> æ•™å­¸é‡é»ï¼šè§£æåº¦</div>
                                <p>ã€Œè§£æåº¦ã€å°±æ˜¯æ ¼å­çš„å¯†åº¦ã€‚ç•¶æ ¼å­å¾ˆå°‘ï¼ˆä¾‹å¦‚ 7x7ï¼‰æ™‚ï¼Œåœ–ç‰‡æœƒè®Šå¾—åƒé¦¬è³½å…‹ä¸€æ¨£æ¨¡ç³Šï¼›æ ¼å­è¶Šå¤šï¼ˆä¾‹å¦‚ 100x100ï¼‰ï¼Œåœ–ç‰‡å°±è¶Šæ¸…æ™°ï¼Œä½†ä¹Ÿéœ€è¦æ›´å¤šç©ºé–“ä¾†å­˜é€™äº›æ ¼å­çš„è³‡æ–™å–”ï¼</p>
                            </div>

                            <button onClick={() => { onSubmit(0, { finalRes: res }, 10); onNext(); }} 
                                className="fun-btn w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold shadow-md shadow-indigo-200">
                                æˆ‘æ‡‚äº†ï¼Œä¸‹ä¸€é—œ
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Level 1: Pixel Art ---
        const Level1_PixelArt = ({ onNext, onSubmit }) => {
            const [gridSize, setGridSize] = useState(8);
            const [pixels, setPixels] = useState([]);
            
            // ç°¡å–®çš„ 8x8 ç¬‘è‡‰ç·´ç¿’ç¯„ä¾‹
            const exampleSmiley = [
                0,0,1,1,1,1,0,0,
                0,1,0,0,0,0,1,0,
                1,0,1,0,0,1,0,1,
                1,0,0,0,0,0,0,1,
                1,0,1,0,0,1,0,1,
                1,0,0,1,1,0,0,1,
                0,1,0,0,0,0,1,0,
                0,0,1,1,1,1,0,0
            ];

            useEffect(() => setPixels(Array(gridSize * gridSize).fill(false)), [gridSize]);
            const togglePixel = (i) => { const p = [...pixels]; p[i] = !p[i]; setPixels(p); };

            return (
                <div className="flex flex-col h-full gap-6">
                    <div className="flex justify-between items-end border-b border-slate-100 pb-4">
                        <div>
                            <div className="flex items-center gap-2 mb-1">
                                <span className="bg-orange-100 text-orange-600 px-2 py-0.5 rounded text-xs font-bold">Level 1</span>
                                <h2 className="text-2xl font-bold text-slate-800">åƒç´ ç•«æ¿</h2>
                            </div>
                            <p className="text-slate-500">é»æ“Šæ ¼å­ä½œç•«ï¼Œè§€å¯Ÿåƒç´ ç¸½æ•¸çš„è®ŠåŒ–ã€‚</p>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={()=>setGridSize(8)} className={`px-4 py-2 rounded-lg font-bold transition-colors ${gridSize===8 ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200':'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>8x8</button>
                            <button onClick={()=>setGridSize(16)} className={`px-4 py-2 rounded-lg font-bold transition-colors ${gridSize===16 ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200':'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>16x16</button>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col md:flex-row gap-8 justify-center items-start">
                        {/* å·¦å´ï¼šç·´ç¿’ç¯„ä¾‹ (åªåœ¨ 8x8 é¡¯ç¤º) */}
                        {gridSize === 8 && (
                            <div className="flex flex-col items-center">
                                <div className="text-sm font-bold text-slate-500 mb-2">ç·´ç¿’ç¯„ä¾‹ (è©¦è‘—ç•«ç•«çœ‹)</div>
                                <div className="target-box">
                                    <div className="grid gap-1 grid-cols-8">
                                        {exampleSmiley.map((v, i) => (
                                            <div key={i} className={`w-6 h-6 rounded border border-slate-200 ${v ? 'bg-slate-800' : 'bg-white'}`}></div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* ä¸­é–“ï¼šç•«å¸ƒ */}
                        <div className="flex flex-col items-center">
                            <div className="aspect-square w-[320px] h-[320px] pixel-grid shadow-inner bg-white" style={{ gridTemplateColumns: `repeat(${gridSize}, 1fr)` }}>
                                {pixels.map((p, i) => <div key={i} onMouseDown={() => togglePixel(i)} onMouseEnter={(e) => e.buttons === 1 && togglePixel(i)} className={`pixel-cell ${p ? 'bg-slate-800' : 'bg-white'}`}></div>)}
                            </div>
                        </div>

                        {/* å³å´ï¼šæ•¸æ“šèˆ‡èªªæ˜ */}
                        <div className="w-full md:w-64 flex flex-col gap-4">
                            <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg space-y-3">
                                <div className="flex justify-between"><span className="text-slate-500">è§£æåº¦</span><span className="font-bold text-indigo-600">{gridSize} x {gridSize}</span></div>
                                <div className="flex justify-between"><span className="text-slate-500">ç¸½åƒç´ </span><span className="font-bold text-orange-500">{gridSize * gridSize} px</span></div>
                                <div className="flex justify-between border-t pt-2"><span className="text-slate-500">é»‘è‰²é»</span><span className="font-bold">{pixels.filter(Boolean).length}</span></div>
                            </div>
                            
                            <div className="guide-box">
                                <div className="guide-title"><Lightbulb size={18}/> æ•™å­¸é‡é»ï¼šåƒç´ </div>
                                <p>é€™å°±æ˜¯ã€Œé»é™£åœ–ã€ï¼è€Œåœ¨æ•¸ä½å½±åƒä¸­ï¼Œ<strong>æœ€å°çš„å–®ä½å°±æ˜¯ã€Œåƒç´  (Pixel)ã€</strong>ã€‚é›»è…¦å¿…é ˆè¨˜éŒ„æ¯ä¸€å€‹åƒç´ çš„é¡è‰²ã€‚8x8 çš„åœ–æœ‰ 64 å€‹åƒç´ ï¼Œè®Šæˆ 16x16 å¾Œå°±æœ‰ 256 å€‹åƒç´ ï¼Œæª”æ¡ˆå¤§å°æœƒè®Šæˆ 4 å€å–”ï¼</p>
                            </div>

                            <button onClick={() => { onSubmit(1, { gridSize: `${gridSize}x${gridSize}` }, 15); onNext(); }} className="fun-btn w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-indigo-200">è¨˜éŒ„æ•¸æ“š (+15åˆ†)</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Level 2: Binary ---
        const Level2_Binary = ({ onNext, onSubmit }) => {
            const [rows, setRows] = useState(Array(8).fill(0));
            // ç›®æ¨™åœ–å½¢ï¼šä¸€å€‹ç°¡å–®çš„ "Hi" (5x7)
            const targetRows = [0, 148, 144, 244, 148, 148, 0, 0];
            const [isMatch, setIsMatch] = useState(false);

            const toggleBit = (r, c) => { 
                const n = [...rows]; n[r] ^= (1 << (7 - c)); setRows(n); 
            };
            const toBin = (n) => n.toString(2).padStart(8, '0');

            // æª¢æŸ¥æ˜¯å¦ç¬¦åˆç›®æ¨™
            useEffect(() => {
                const currentMatch = JSON.stringify(rows) === JSON.stringify(targetRows);
                setIsMatch(currentMatch);
            }, [rows]);

            return (
                <div className="flex flex-col h-full gap-6">
                    <div className="border-b border-slate-100 pb-4">
                        <div className="flex items-center gap-2 mb-1">
                            <span className="bg-orange-100 text-orange-600 px-2 py-0.5 rounded text-xs font-bold">Level 2</span>
                            <h2 className="text-2xl font-bold text-slate-800">0èˆ‡1çš„ä¸–ç•Œ</h2>
                        </div>
                        <p className="text-slate-500">é›»è…¦åªæ‡‚ 0 èˆ‡ 1ã€‚è«‹è§€å¯Ÿå·¦é‚Šçš„ç›®æ¨™åœ–æ¡ˆï¼Œå°‡å³é‚Šçš„æ ¼å­ç•«æˆä¸€æ¨£çš„ã€‚</p>
                    </div>

                    <div className="flex flex-col md:flex-row gap-8 items-start justify-center">
                        {/* å·¦å´ç›®æ¨™å€ */}
                        <div className="flex flex-col items-center">
                            <div className="text-sm font-bold text-slate-500 mb-2">ç›®æ¨™åœ–å½¢</div>
                            <div className="target-box">
                                <div className="grid gap-1">
                                    {targetRows.map((val, r) => (
                                        <div key={r} className="flex gap-1">
                                            {Array(8).fill(0).map((_, c) => {
                                                const isB = (val >> (7 - c)) & 1;
                                                return <div key={c} className={`w-6 h-6 rounded flex items-center justify-center text-[10px] ${isB ? 'bg-slate-800 text-white' : 'bg-white border border-slate-200 text-slate-300'}`}></div>
                                            })}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* å³å´æ“ä½œå€ */}
                        <div className="flex flex-col items-center">
                            <div className="text-sm font-bold text-slate-500 mb-2">ä½ çš„ç•«å¸ƒ (é»æ“Šä¿®æ”¹)</div>
                            <div className="flex gap-4 items-start bg-slate-50 p-6 rounded-3xl border border-slate-100 shadow-inner">
                                <div className="grid gap-1">
                                    {rows.map((val, r) => (
                                        <div key={r} className="flex gap-1">
                                            {Array(8).fill(0).map((_, c) => {
                                                const isB = (val >> (7 - c)) & 1;
                                                return <div key={c} onClick={() => toggleBit(r, c)} className={`w-8 h-8 md:w-10 md:h-10 border rounded cursor-pointer flex items-center justify-center text-xs font-bold transition-colors ${isB ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-300 border-slate-200 hover:border-indigo-300'}`}>{isB ? '1' : '0'}</div>
                                            })}
                                        </div>
                                    ))}
                                </div>
                                <div className="flex flex-col gap-1 pt-0 font-mono text-lg md:text-2xl font-bold text-indigo-600">
                                    {rows.map((v, i) => <div key={i} className="h-8 md:h-10 flex items-center tracking-widest bg-white px-3 rounded border border-indigo-100 shadow-sm">{toBin(v)}</div>)}
                                </div>
                            </div>
                        </div>
                    </div>
                        
                    <div className="flex justify-center mt-4">
                        {isMatch ? (
                            <div className="text-center animate-bounce">
                                <div className="text-green-500 font-bold text-xl mb-2 flex items-center gap-2 justify-center"><CheckCircle/> æŒ‘æˆ°æˆåŠŸï¼</div>
                                <button onClick={() => { onSubmit(2, { binary: rows.map(toBin) }, 15); onNext(); }} className="fun-btn bg-indigo-600 text-white py-3 px-12 rounded-xl font-bold shadow-lg shadow-indigo-200">é€²å…¥ä¸‹ä¸€é—œ (+15åˆ†)</button>
                            </div>
                        ) : (
                             <div className="guide-box max-w-2xl">
                                <div className="guide-title"><Lightbulb size={18}/> æ•™å­¸é‡é»ï¼šäºŒé€²ä½</div>
                                <p>è«‹è©¦è‘—æŠŠå³é‚Šçš„åœ–æ¡ˆç•«å¾—è·Ÿå·¦é‚Šä¸€æ¨£ï¼ä½ æœƒç™¼ç¾ï¼Œæ¯ä¸€å€‹é»‘è‰²æ ¼å­éƒ½å°æ‡‰åˆ°æ•¸å­—ã€Œ1ã€ï¼Œç™½è‰²å‰‡æ˜¯ã€Œ0ã€ã€‚</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- Level 3: Color Depth ---
        const Level3_ColorDepth = ({ onNext, onSubmit }) => {
            const [depth, setDepth] = useState(2); // é è¨­ 2 bits
            const [grid, setGrid] = useState(Array(64).fill(0));
            const pals = { 1: ['#fff','#000'], 2: ['#fff','#000','#f00','#00f'], 3: ['#fff','#000','#f00','#0f0','#00f','#ff0','#0ff','#f0f'] };
            
            // ç›®æ¨™ï¼š2 bits æ„›å¿ƒ
            const targetGrid = [
                0,1,1,0,0,1,1,0,
                1,2,2,1,1,2,2,1,
                1,2,2,2,2,2,2,1,
                1,2,2,2,2,2,2,1,
                0,1,2,2,2,2,1,0,
                0,0,1,2,2,1,0,0,
                0,0,0,1,1,0,0,0,
                0,0,0,0,0,0,0,0
            ];
            
            const [isMatch, setIsMatch] = useState(false);

            useEffect(() => setGrid(Array(64).fill(0)), [depth]);
            
            useEffect(() => {
                // åªæœ‰åœ¨ depth ç‚º 2 æ™‚æ‰æª¢æŸ¥
                if (depth === 2) {
                    setIsMatch(JSON.stringify(grid) === JSON.stringify(targetGrid));
                } else {
                    setIsMatch(false);
                }
            }, [grid, depth]);

            const cycleColor = (i) => { setGrid(g => { const n = [...g]; n[i] = (n[i] + 1) % (1 << depth); return n; }); };

            return (
                <div className="flex flex-col h-full gap-6">
                    <div className="border-b border-slate-100 pb-4">
                        <div className="flex items-center gap-2 mb-1">
                            <span className="bg-orange-100 text-orange-600 px-2 py-0.5 rounded text-xs font-bold">Level 3</span>
                            <h2 className="text-2xl font-bold text-slate-800">è‰²å½©çš„ä»£åƒ¹</h2>
                        </div>
                        <p className="text-slate-500">é¡è‰²è¶Šå¤šï¼Œéœ€è¦çš„ã€Œä½å…ƒ(bit)ã€è¶Šå¤šï¼Œæª”æ¡ˆå°±è¶Šå¤§ã€‚</p>
                    </div>

                    <div className="flex flex-col md:flex-row gap-8 justify-center items-start">
                        {/* å·¦å´æ§åˆ¶èˆ‡ç›®æ¨™ */}
                        <div className="w-full md:w-1/4 space-y-4">
                            <div className="text-sm font-bold text-slate-500">é¸æ“‡æ¨¡å¼</div>
                            <div className="space-y-2">
                                {[1, 2, 3].map(d => (
                                    <button key={d} onClick={()=>setDepth(d)} className={`w-full p-3 rounded-xl border text-left transition-all ${depth===d ? 'bg-indigo-50 border-indigo-500 ring-2 ring-indigo-200':'border-slate-200 hover:bg-slate-50'}`}>
                                        <div className="font-bold text-slate-800">{d} Bit{d>1?'s':''} {d===2 && <span className="text-xs bg-red-100 text-red-600 px-1 rounded ml-1">æŒ‘æˆ°ç›®æ¨™</span>}</div>
                                        <div className="text-xs text-slate-500">{Math.pow(2,d)} ç¨®é¡è‰²</div>
                                    </button>
                                ))}
                            </div>

                            <div className="target-box mt-4">
                                <div className="text-xs font-bold text-slate-600 mb-2 text-center">æŒ‘æˆ°ç›®æ¨™ (è«‹ç”¨ 2 Bits)</div>
                                <div className="grid grid-cols-8 gap-0.5 bg-white p-1 rounded border border-slate-200">
                                    {targetGrid.map((c, i) => (
                                        // ä½¿ç”¨ palette 2 çš„é¡è‰²
                                        <div key={i} className="w-full aspect-square" style={{backgroundColor: pals[2][c]}}></div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* ä¸­é–“ç•«å¸ƒ */}
                        <div className="flex flex-col items-center">
                            <div className="text-sm font-bold text-slate-500 mb-2">ä½ çš„ç•«å¸ƒ (ç›®å‰: {depth} Bits)</div>
                            <div className="grid grid-cols-8 gap-1 bg-white p-2 rounded-xl shadow-lg border border-slate-200">
                                {grid.map((c, i) => <div key={i} onMouseDown={()=>cycleColor(i)} className="w-8 h-8 md:w-10 md:h-10 rounded-sm cursor-pointer border border-slate-100 hover:opacity-80 transition-opacity" style={{backgroundColor: pals[depth][c]}}></div>)}
                            </div>
                            
                            <div className="mt-4 bg-slate-100 p-2 rounded-xl w-full text-center">
                                <div className="text-xs text-slate-500 mb-2">è‰²ç¥¨ (é»æ“Šç•«å¸ƒåˆ‡æ›)</div>
                                <div className="flex gap-2 justify-center">{pals[depth].map((c,i)=><div key={i} className="w-8 h-8 rounded border border-slate-300 shadow-sm" style={{backgroundColor:c}}></div>)}</div>
                            </div>
                        </div>

                        {/* å³å´è³‡è¨Š */}
                        <div className="w-full md:w-1/4 flex flex-col gap-4">
                            <div className="bg-slate-800 text-white p-5 rounded-2xl shadow-xl">
                                <h3 className="font-bold text-indigo-300 mb-4 border-b border-slate-600 pb-2">æª”æ¡ˆå¤§å°è¨ˆç®—</h3>
                                <div className="space-y-3 text-sm font-mono">
                                    <div className="flex justify-between"><span>64 åƒç´  x</span><span className="text-yellow-400">{depth} bits</span></div>
                                    <div className="border-t border-slate-600 pt-3 flex justify-between text-xl font-bold text-green-400">
                                        <span>Total:</span><span>{64 * depth} bits</span>
                                    </div>
                                </div>
                            </div>

                            {isMatch ? (
                                <div className="text-center animate-bounce mt-4">
                                    <div className="text-green-500 font-bold text-xl mb-2 flex items-center gap-2 justify-center"><CheckCircle/> å®Œç¾è¤‡è£½ï¼</div>
                                    <button onClick={() => { onSubmit(3, { depth, fileSize: 64*depth }, 20); onNext(); }} className="fun-btn w-full bg-white text-slate-900 py-3 rounded-xl font-bold border-2 border-green-500 hover:bg-green-50">ä¸Šå‚³ç´€éŒ„ (+20åˆ†)</button>
                                </div>
                            ) : (
                                <div className="guide-box">
                                    <div className="guide-title"><Lightbulb size={18}/> æŒ‘æˆ°ä»»å‹™</div>
                                    <p>è«‹åˆ‡æ›åˆ° <strong>2 Bits</strong> æ¨¡å¼ï¼Œä¸¦è©¦è‘—ç•«å‡ºå·¦é‚Šçš„æ„›å¿ƒåœ–æ¡ˆï¼ä½ æœƒç™¼ç¾ï¼Œé¡è‰²è¶Šå¤šï¼Œæª”æ¡ˆå°±è¶Šå¤§å–”ã€‚</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Level 4: RLE ---
        const Level4_RLE = ({ onNext, onSubmit }) => {
            const [grid, setGrid] = useState(Array(64).fill(0));
            const target = [0,0,0,0,0,0,0,0, 0,0,1,1,1,1,0,0, 0,1,0,0,0,0,1,0, 0,1,0,1,1,0,1,0, 0,1,0,1,1,0,1,0, 0,1,0,0,0,0,1,0, 0,0,1,1,1,1,0,0, 0,0,0,0,0,0,0,0];
            const clues = ["ç¬¬1è¡Œ: 8ç™½", "ç¬¬2è¡Œ: 2ç™½, 4é»‘, 2ç™½", "ç¬¬3è¡Œ: 1ç™½, 1é»‘, 4ç™½, 1é»‘, 1ç™½", "ç¬¬4è¡Œ: 1ç™½, 1é»‘, 1ç™½, 2é»‘, 1ç™½, 1é»‘, 1ç™½", "ç¬¬5è¡Œ: åŒä¸Š", "ç¬¬6è¡Œ: 1ç™½, 1é»‘, 4ç™½, 1é»‘, 1ç™½", "ç¬¬7è¡Œ: 2ç™½, 4é»‘, 2ç™½", "ç¬¬8è¡Œ: 8ç™½"];
            const toggle = (i) => { const n = [...grid]; n[i] = n[i]===0?1:0; setGrid(n); };
            const isWin = JSON.stringify(grid) === JSON.stringify(target);

            return (
                <div className="flex flex-col h-full gap-6">
                    <div className="border-b border-slate-100 pb-4">
                        <div className="flex items-center gap-2 mb-1">
                            <span className="bg-orange-100 text-orange-600 px-2 py-0.5 rounded text-xs font-bold">Level 4</span>
                            <h2 className="text-2xl font-bold text-slate-800">è³‡æ–™å£“ç¸®è¡“ (RLE)</h2>
                        </div>
                        <p className="text-slate-500">é›»è…¦ä¸èªªã€Œç™½ç™½ç™½ã€ï¼Œå®ƒèªªã€Œ3ç™½ã€ã€‚è«‹ä¾å·¦å´å¯†ç¢¼é‚„åŸåœ–ç‰‡ã€‚</p>
                    </div>

                    <div className="flex-1 flex flex-col md:flex-row gap-8 justify-center items-center">
                        <div className="bg-slate-800 text-green-400 p-6 rounded-2xl font-mono text-sm shadow-xl w-64 border border-slate-600">
                            <h3 className="border-b border-slate-600 pb-2 mb-3 font-bold text-center text-white">ENCODED DATA</h3>
                            {clues.map((c, i) => <div key={i} className="mb-1 opacity-80">{c}</div>)}
                        </div>

                        <div>
                            <div className="grid grid-cols-8 gap-1 p-2 bg-slate-200 rounded-lg">
                                {grid.map((v, i) => <div key={i} onClick={() => toggle(i)} className={`w-10 h-10 rounded transition-colors cursor-pointer ${v===1 ? 'bg-slate-800' : 'bg-white'}`}></div>)}
                            </div>
                             <div className="guide-box max-w-sm mt-4">
                                <div className="guide-title"><Lightbulb size={18}/> æ•™å­¸é‡é»ï¼šè³‡æ–™å£“ç¸®</div>
                                <p>RLE (è¡Œç¨‹ç·¨ç¢¼) æ˜¯ä¸€ç¨®è°æ˜çš„ç´€éŒ„æ–¹å¼ã€‚å®ƒçš„ä¸»è¦ç›®çš„å°±æ˜¯**å£“ç¸®æª”æ¡ˆå¤§å°**ã€‚å¦‚æœä¸€è¡Œæœ‰ 100 å€‹ç™½è‰²åƒç´ ï¼Œæˆ‘å€‘ä¸ç”¨å­˜ 100 å€‹ 0ï¼Œåªè¦å­˜ã€Œ100å€‹ç™½ã€å°±å¥½äº†ï¼é€™æ¨£å¯ä»¥å¤§å¤§ç¯€çœå„²å­˜ç©ºé–“èˆ‡å‚³è¼¸æ™‚é–“ã€‚</p>
                            </div>
                        </div>

                        <div className="w-32 flex justify-center">
                            {isWin ? (
                                <div className="text-center animate-bounce">
                                    <CheckCircle size={56} className="text-green-500 mx-auto mb-2"/>
                                    <button onClick={() => { onSubmit(4, { success: true }, 20); onNext(); }} className="fun-btn bg-green-500 text-white px-4 py-2 rounded-lg font-bold shadow-lg shadow-green-200">è§£ç¢¼æˆåŠŸ (+20)</button>
                                </div>
                            ) : <div className="text-slate-400 text-center font-bold">ç­‰å¾…è§£ç¢¼...</div>}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Level 5: Boss ---
        const Level5_Boss = ({ onNext, onSubmit }) => {
            const [input, setInput] = useState("");
            const [msg, setMsg] = useState(null);
            const problem = [0,0,0,1,1,0,1,0]; // 3W 2B 1W 1B 1W

            const check = () => {
                if (input.replace(/\s/g, '').replace(/ï¼Œ/g, ',') === "3,2,1,1,1") {
                    setMsg("correct");
                    setTimeout(() => { onSubmit(5, { bossDefeated: true }, 20); onNext(); }, 1500);
                } else {
                    setMsg("error");
                }
            };

            return (
                <div className="flex flex-col h-full items-center justify-center text-center gap-8">
                    <div className="animate-pulse">
                        <h2 className="text-3xl font-extrabold text-red-500 flex items-center justify-center gap-3"><Lock size={32}/> BOSS STAGE</h2>
                        <p className="text-slate-500 mt-2">ç³»çµ±åµæ¸¬åˆ°å—æè³‡æ–™ã€‚è«‹è§€å¯Ÿåƒç´ ï¼Œè¼¸å…¥ RLE å£“ç¸®ç¢¼ä¿®å¾©å®ƒã€‚</p>
                    </div>

                    <div className="bg-white p-10 rounded-3xl border-2 border-red-100 shadow-2xl w-full max-w-lg relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-2 bg-red-500"></div>
                        
                        <div className="flex gap-1 justify-center mb-8 bg-slate-100 p-4 rounded-xl">
                            {problem.map((v, i) => <div key={i} className={`w-12 h-12 rounded border-2 border-slate-300 ${v===1 ? 'bg-slate-800' : 'bg-white'}`}></div>)}
                        </div>

                        <p className="text-slate-400 text-sm mb-2">æ ¼å¼ç¯„ä¾‹ï¼š3,2,1 (3ç™½, 2é»‘, 1ç™½)</p>
                        <input type="text" placeholder="è¼¸å…¥ä»£ç¢¼..." className="text-center text-2xl font-mono tracking-widest border-2 border-slate-200 rounded-xl p-3 w-full mb-4 focus:border-red-400 outline-none transition-colors" value={input} onChange={e=>setInput(e.target.value)} />
                        
                        <button onClick={check} className="fun-btn w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-red-200 text-xl">åŸ·è¡Œä¿®å¾©æŒ‡ä»¤</button>
                        
                        {msg === "error" && <div className="mt-4 text-red-500 font-bold animate-shake">âŒ ç·¨ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¨ˆç®—ï¼</div>}
                        {msg === "correct" && <div className="mt-4 text-green-500 font-bold text-xl">âœ… ä¿®å¾©æˆåŠŸï¼ç³»çµ±é‡å•Ÿä¸­...</div>}
                    </div>

                    <div className="guide-box max-w-lg mx-auto">
                         <div className="guide-title"><Lightbulb size={18}/> æœ€çµ‚æŒ‘æˆ°</div>
                         <p>é€™å°±æ˜¯çœŸå¯¦çš„ã€Œé€†å‘å·¥ç¨‹ã€ã€‚ä½ è¦åƒé›»è…¦å·¥ç¨‹å¸«ä¸€æ¨£ï¼Œçœ‹è‘—å½±åƒï¼Œæ€è€ƒå®ƒèƒŒå¾Œçš„è³‡æ–™çµæ§‹æ˜¯é•·ä»€éº¼æ¨£å­çš„ã€‚</p>
                    </div>
                </div>
            );
        };

        // --- New Level 6: Quiz ---
        const Level6_Quiz = ({ onNext, onSubmit }) => {
            const [answers, setAnswers] = useState({});
            const questions = [
                { id: 1, q: "1. æ•¸ä½å½±åƒä¸­ï¼Œæœ€å°çš„å–®ä½æ˜¯ï¼Ÿ", opts: ["å…¬åˆ† (cm)", "åƒç´  (Pixel)", "ä½å…ƒçµ„ (Byte)"], ans: "åƒç´  (Pixel)" },
                { id: 2, q: "2. åœ¨é»‘ç™½äºŒé€²ä½åœ–ç‰‡ä¸­ï¼Œé€šå¸¸ 0 ä»£è¡¨ï¼Ÿ", opts: ["ç´…è‰²", "é»‘è‰²", "ç™½è‰²"], ans: "ç™½è‰²" },
                { id: 3, q: "3. ä¸€å¼µ 8x8 çš„åœ–ç‰‡ï¼Œè‹¥ç”¨ 2 bits å„²å­˜é¡è‰²ï¼Œæª”æ¡ˆå¤§å°æ˜¯ï¼Ÿ", opts: ["64 bits", "128 bits", "256 bits"], ans: "128 bits" },
                { id: 4, q: "4. RLE (è¡Œç¨‹ç·¨ç¢¼) çš„ä¸»è¦ç›®çš„æ˜¯ï¼Ÿ", opts: ["è®“åœ–ç‰‡è®Šæ¨¡ç³Š", "å£“ç¸®æª”æ¡ˆå¤§å°", "å¢åŠ è‰²å½©"], ans: "å£“ç¸®æª”æ¡ˆå¤§å°" }
            ];

            const handleSubmit = () => {
                let score = 0;
                questions.forEach(q => { if(answers[q.id] === q.ans) score += 5; }); // æ¯é¡Œ 5 åˆ†ï¼Œå…± 20 åˆ†
                onSubmit(6, { quizAnswers: answers }, score);
                onNext();
            };

            return (
                <div className="flex flex-col h-full gap-6">
                    <div className="border-b border-slate-100 pb-4">
                        <div className="flex items-center gap-2 mb-1">
                            <span className="bg-orange-100 text-orange-600 px-2 py-0.5 rounded text-xs font-bold">Bonus</span>
                            <h2 className="text-2xl font-bold text-slate-800">è§€å¿µç¸½é©—æ”¶</h2>
                        </div>
                        <p className="text-slate-500">æœ€å¾Œçš„æŒ‘æˆ°ï¼æ¯é¡Œ 5 åˆ†ï¼Œå…± 20 åˆ†ã€‚</p>
                    </div>

                    <div className="flex-1 overflow-y-auto space-y-6 px-2">
                        {questions.map((q) => (
                            <div key={q.id} className="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                                <h3 className="font-bold text-lg text-slate-700 mb-3">{q.q}</h3>
                                <div className="grid grid-cols-3 gap-3">
                                    {q.opts.map(opt => (
                                        <button key={opt} onClick={() => setAnswers({...answers, [q.id]: opt})} className={`py-3 rounded-xl text-sm font-bold transition-all ${answers[q.id]===opt ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-50 text-slate-600 hover:bg-slate-100'}`}>{opt}</button>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    <button onClick={handleSubmit} disabled={Object.keys(answers).length < 4} className="fun-btn w-full bg-gradient-to-r from-orange-500 to-pink-500 text-white py-4 rounded-xl font-bold shadow-lg shadow-orange-200 disabled:opacity-50 text-xl">æäº¤è©¦å·</button>
                </div>
            );
        };

        // --- End Screen ---
        const EndScreen = ({ userInfo, score, gameData, showToast }) => {
            const [sending, setSending] = useState(false);
            const [sent, setSent] = useState(false);

            const handleSendReport = async () => {
                setSending(true);
                const reportData = { toTeacher: "t0733@ymsh.tp.edu.tw", toStudent: userInfo.email, subject: `[æ•¸ä½å½±åƒå¯¦é©—å®¤] æˆç¸¾å–® - ${userInfo.classCode}${userInfo.seatNo} ${userInfo.name}`, body: { student: userInfo.name, finalScore: score, details: gameData } };
                console.log("ğŸ“¨ æ­£åœ¨å¯„é€éƒµä»¶...", reportData);
                setTimeout(() => {
                    setSending(false);
                    setSent(true);
                    if (Math.random() > 0.1) { showToast(`æˆç¸¾å·²å¯„é€è‡³ ${userInfo.email} èˆ‡è€å¸«ä¿¡ç®±ï¼`, 'success'); } else { showToast("å¯„é€å¤±æ•—ï¼Œè«‹æˆªåœ–ä¿å­˜æˆç¸¾ã€‚", "error"); }
                }, 2000);
            };
            useEffect(() => { if(!sent && !sending) handleSendReport(); }, []);

            return (
                <div className="h-full flex flex-col items-center justify-center text-center space-y-8 animate-[slideIn_0.5s_ease-out]">
                    <div className="relative">
                        <div className="w-32 h-32 bg-yellow-400 rounded-full flex items-center justify-center shadow-lg shadow-yellow-200 animate-bounce"><Award size={80} className="text-white"/></div>
                        <div className="absolute -bottom-2 -right-2 bg-indigo-600 text-white w-12 h-12 rounded-full flex items-center justify-center font-bold text-xl border-4 border-white">{score}</div>
                    </div>
                    <div><h2 className="text-4xl font-extrabold text-slate-800 mb-2">æ­å–œå®Œæˆå¯¦é©—ï¼</h2><p className="text-slate-500">å­¸å“¡ï¼š<span className="font-bold text-indigo-600">{userInfo.name}</span> | æœ€çµ‚ç©åˆ†ï¼š<span className="font-bold text-orange-500 text-2xl">{score}</span> / 120</p></div>
                    <div className="bg-white p-6 rounded-2xl w-full max-w-md border border-slate-100 shadow-xl text-left space-y-4">
                        <h3 className="font-bold text-slate-700 flex items-center gap-2 border-b pb-2"><Send size={18}/> å­¸ç¿’æ­·ç¨‹å‚³é€ç‹€æ…‹</h3>
                        <div className="space-y-3">
                            <div className="flex items-center justify-between text-sm"><span className="text-slate-500">æŒ‡å°è€å¸« (t0733)</span>{sending ? <span className="text-orange-500 animate-pulse">å‚³é€ä¸­...</span> : <span className="text-green-600 font-bold flex items-center gap-1"><CheckCircle size={14}/> å·²é€é”</span>}</div>
                            <div className="flex items-center justify-between text-sm"><span className="text-slate-500">å­¸å“¡å­˜æŸ¥ ({userInfo.email})</span>{sending ? <span className="text-orange-500 animate-pulse">å‚³é€ä¸­...</span> : <span className="text-green-600 font-bold flex items-center gap-1"><CheckCircle size={14}/> å·²é€é”</span>}</div>
                        </div>
                        <div className="bg-slate-50 p-3 rounded-xl text-xs text-slate-400 mt-4">ç³»çµ±å·²è‡ªå‹•å°‡ä½ çš„ç­”é¡Œè©³ç´°è¨˜éŒ„æ‰“åŒ…å¯„å‡ºã€‚è«‹æª¢æŸ¥ä½ çš„ä¿¡ç®±ï¼ˆå«åƒåœ¾éƒµä»¶åŒ£ï¼‰ã€‚</div>
                    </div>
                    <button onClick={() => window.location.reload()} className="flex items-center gap-2 text-slate-400 hover:text-indigo-600 transition-colors font-bold"><RotateCcw size={18}/> é‡æ–°æŒ‘æˆ°</button>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
